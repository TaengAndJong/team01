<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.team01.admin.dao.QnaProductDao">  <!--사용하는 Dao 연결-->
    <!--메서드 구현부-->
   <!--구현 방식 ex) <select id = "Dao에서 정의한 메서드명"></select>-->

    <select id="totalRecord" resultType="int" parameterType="com.example.team01.utils.Pagination">
        SELECT COUNT(*)
        FROM qnaPro
    </select>

     <sql id="searchFrag">
        <trim prefix="AND" suffixOverrides="AND">

            <!-- 답변 상태 필터 (searchType에 따라 qnaStatus 필터링) -->
            <choose>
                <when test="pagination.detailCondition.searchType == 'Replied'">
                    "qnaStatus" = '답변' AND
                </when>
                <when test="pagination.detailCondition.searchType == 'Waiting'">
                    "qnaStatus" = '미답변' AND
                </when>
            </choose>

            <!-- 키워드가 존재할 경우, 전체 컬럼 검색 -->
            <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(pagination.detailCondition.keyword)">
                (
                INSTR("qnaTitle", #{pagination.detailCondition.keyword}) > 0 OR
                INSTR("qnaWriter", #{pagination.detailCondition.keyword}) > 0 OR
                INSTR("qnaStatus", #{pagination.detailCondition.keyword}) > 0 OR
                INSTR(TO_CHAR("qnaDate", 'YYYY-MM-DD HH24:MI:SS'), #{pagination.detailCondition.keyword}) > 0 OR
                INSTR("clientId", #{pagination.detailCondition.keyword}) > 0
                ) AND
            </if>
        </trim>
    </sql>

    <select id="getAllQnaProductList" resultType="QnaProductVO" parameterType="com.example.team01.utils.Pagination">
        with filterData as (
            select ROWNUM as rnum,a.*
            from(
                SELECT TRIM("qnaProId") AS "qnaProId"
                    , "qnaTitle"
                    , "qnaWriter"
                    , "clientId"
                    , "qnaStatus"
                    , "qnaDate"
                FROM qnaPro
                WHERE ("qnaDel" IS NULL OR "qnaDel" = 'N')
                <include refid="searchFrag" />
                ORDER BY "qnaProId" DESC
            ) a
        )
        SELECT *
        FROM filterData
        WHERE rnum BETWEEN #{pagination.startRow} AND #{pagination.endRow}
    </select>

    <select id="getProDetailBoard" resultType="QnaProductVO" parameterType="map">
        SELECT "qnaProId",
        "qnaTitle", 
        TO_CHAR("qnaContent") as qnaContent,
        "qnaWriter",
        "qnaDate",
        "qnaDel",
        "qnaStatus",
        "clientId",
        "roleId",
        "attachmentID"
    FROM qnaPro
    WHERE "qnaProId" = #{boardId}
    AND "clientId" = #{userId}
    AND ROWNUM = 1
    </select>

    <delete id="deleteProductBoard" parameterType="String">
        update qnaPro
        set "qnaDel" = 'Y', 
        "qnaDelDate" = SYSDATE
        where "qnaProId" = #{boardId}
    </delete>
        
</mapper>