<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.team01.delivery.dao.AddressDao">
  
    <resultMap id="addressMap" type="AddressVO">
        <id property="addrId" column="addrId"/>
        <result property="addrType" column="addrType"/>
        <result property="addr" column="addr"/>
        <result property="zoneCode" column="zoneCode"/>
        <result property="detailAddr" column="detailAddr"/>
        <association property="client" javaType="ClientVO">
            <id property="clientId" column="clientId"/>
        </association>
    </resultMap>
    
    <select id="selectAddress" parameterType="String" resultMap="addressMap">
        select
            a.addrId
            , c.clientId
            , a.addrType
            , a.addr
            , a.zoneCode
            , a.detailAddr
        from Address a join CLIENT c on  a.clientId = c.clientId
        where c.clientId =  #{clientId}
    </select>

    <insert id="insertAddress" parameterType="AddressVO">
        <selectKey keyProperty="addrId" resultType="String" order="BEFORE">
            SELECT nextval('ADDRID_SQE')
        </selectKey>

        insert into
            Address (
                    addrId
                    ,clientId
                    ,addrType
                    ,addr
                    ,zoneCode
                    ,detailAddr
        )
        values (
                    #{addrId}
                    ,#{client.clientId}
                    ,#{addrType}
                    ,#{addr}
                    ,#{zoneCode}
                    ,#{detailAddr}
               )
    </insert>
    
    <update id="updateAddress" parameterType="AddressVO">
        UPDATE Address
        <set>
            <if test="addrType != null and addrType != ''">
                addrType = #{addrType},
            </if>
            <if test="addr != null and addr != ''">
                addr = #{addr},
            </if>
            <if test="zoneCode != null and zoneCode != ''">
                zoneCode = #{zoneCode},
            </if>
            <if test="detailAddr != null and detailAddr != ''">
                detailAddr = #{detailAddr},
            </if>
        </set>
        where addrId=#{addrId}
    </update>

    <delete id="deleteAddress" parameterType="String">
      delete from Address
      where addrId=#{addrId}
        and clientId=#{clientId}
    </delete>

    <select id="selectCartAddress" parameterType="String" resultMap="addressMap">
        select a.addrId
             ,a.addr
             ,a.addrType
             ,a.detailAddr
             ,a.zoneCode
             ,c.clientId
             ,c.clientName
             ,c.email
             ,c.tel
        from address a join client c
                            on ( a.clientId = c.clientId)
        where a.clientId = #{clientId}
        order by a.addrId
    </select>

    <update id="updateCartAddress" parameterType="String">
        UPDATE client
        SET selecedAddrId = #{addrId}
        WHERE clientId = #{clientId}
    </update>

    <select id="selectChangeAddress" parameterType="String" resultMap="addressMap">
        with cl as (select
                        clientId
                         ,clientName
                         ,selecedAddrId
                    from client
                    where clientId = #{clientId})

        select
            cl.*,
            a.*
        from cl join address a on ( cl.selecedAddrId = a.addrId)
        where cl.selecedAddrId = #{addrId}
    </select>

    <!--  client 테이블과 address 테이블 조인해서 selectedId 조회해오기 -->
    <select id="selectOneAddress"  parameterType="String" resultMap="addressMap">
        select
            c.clientName,
            c.roleId,
            c.staffId,
            c.clientId,
            a.addrId,
            a.addrType,
            a.addr,
            a.detailAddr,
            a.zoneCode
        from
            (select
                 *
             from client
             where clientId=#{clientId}) c
                join address a on (c.selecedAddrId = a.addrId)
    </select>

</mapper>