<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.team01.wishList.dao.WishListDao">
  
    <resultMap id="wishListMap" type="WishListVO">
        <id property="wishId" column="wishId"/>
        <result property="wishDate" column="wishDate"/>
        <result property="wishStatus" column="wishStatus"/>
        <association property="clientVO" javaType="ClientVO">
            <id property="clientId" column="clientId"/>
            <result property="clientName" column="clientName"/>
        </association>
        <association property="bookVO" javaType="BookVO">
            <id property="bookId" column="bookId"/>
            <result property="bookCateNm" column="bookCateNm"/>
            <result property="bookName" column="bookName"/>
            <result property="author" column="author"/>
            <result property="bookPrice" column="bookPrice"/>
            <result property="publishDate" column="publishDate"/>
            <result property="bookImgPath" column="bookImgPath"/>
        </association>
    </resultMap>


    <sql id="searchFrag">
       <trim prefix="AND" suffixOverrides="AND">

            <!-- bookType이 비어있지 않고 'ALL'이 아닐 때만 필터 적용 -->
            <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(pagination.detailCondition.bookType) and pagination.detailCondition.bookType != 'ALL'">
                INSTR(b.bookCateNm, #{pagination.detailCondition.bookType}) > 0 AND
            </if>

            <!-- keyword가 비어있지 않을 때만 검색조건 적용 -->
            <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(pagination.detailCondition.keyword)">
                <choose>
                    <when test="pagination.detailCondition.searchType == 'bookName'">
                        INSTR(b.bookName, #{pagination.detailCondition.keyword}) > 0 AND
                    </when>
                    <when test="pagination.detailCondition.searchType == 'author'">
                        INSTR(b.author, #{pagination.detailCondition.keyword}) > 0 AND
                    </when>
                </choose>
            </if>

        </trim>
    </sql>
    <!-- 페이지네이션파라미터가 안넘어옴! 파라미터 타입 확인해야함-->
    <select id="totalRecord" resultType="int" parameterType="com.example.team01.utils.Pagination">
        SELECT COUNT(*)
        FROM wishList w
        JOIN book b ON w.bookId = b.bookId
        WHERE w.clientId = #{pagination.clientId}
        AND w.wishStatus = 'Y'
        <include refid="searchFrag"/>
    </select>


    <select id="getWishList" resultMap="wishListMap" parameterType="com.example.team01.utils.Pagination" >
        WITH userWish AS (
        SELECT
            wishId,
            wishDate,
            wishStatus,
            clientId,
            bookId
        FROM wishList
        WHERE clientId = #{pagination.clientId} AND wishStatus = 'Y'
        ),
        filterData AS (
        SELECT
        ROW_NUMBER() OVER (ORDER BY w.wishDate DESC) AS rnum,
            w.wishId,
            w.wishDate,
            w.wishStatus,
            w.clientId,
            b.bookId,
            b.bookName,
            b.bookCateNm,
            b.author,
            b.bookPrice,
            b.publishDate,
            b.bookImgPath
            FROM userWish w
            JOIN book b ON w.bookId = b.bookId
        WHERE 1=1
        <include refid="searchFrag"/>
        )
        SELECT *
        FROM filterData
        WHERE rnum BETWEEN #{pagination.startRow} AND #{pagination.endRow}
    </select>




    <!--    null 방지 처리는 Integer 타입 선언 또는 Count로 결과값 반환 -->
    <select id="existWishList" parameterType="String">
        SELECT COUNT(*) FROM WISHLIST
        WHERE clientId = #{clientId} AND bookId = #{bookId}
    </select>

    <insert id="insertWishList" parameterType="String">
        INSERT INTO WISHLIST
            (clientId,bookId)
        values(#{clientId},#{bookId})
    </insert>


    <!--행을 삭제하지 않아서 유저의 찜목록 히스토리 추적가능-->
    <update id="wishListStatus" parameterType="String">
        update WISHLIST
        set wishStatus =
            case
               when wishStatus= 'Y'
                then 'N'
                else 'Y'
            end
        where clientId=#{clientId}
          and bookId=#{bookId}
    </update>

    <!--해당유저의 찜목록 도서 Id만 조회-->
    <select id="selectWishIds" resultType="string">
        select bookId from wishList
        where clientId = #{clientId} and wishStatus ='Y'
    </select>

    <!-- 3개월 이내 찜목록 조회    -->
    <select id="selectWishCnt" parameterType="String" resultType="int">
        SELECT COUNT(*)
        FROM wishList
         <![CDATA[
        WHERE clientId = #{clientId}
          AND wishDate >= CURRENT_TIMESTAMP - INTERVAL '3 months'
        ]]>
    </select>


</mapper>