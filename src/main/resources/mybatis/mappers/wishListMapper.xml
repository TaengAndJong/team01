<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.team01.wishList.dao.WishListDao">
  
    <resultMap id="wishListMap" type="WishListVO">
        <id property="wishId" column="wishId"/>
        <result property="wishDate" column="wishDate"/>
        <association property="clientVO" javaType="ClientVO">
            <id property="clientId" column="clientId"/>
            <result property="clientName" column="clientName"/>
        </association>
        <association property="bookVO" javaType="BookVO">
            <id property="bookId" column="bookId"/>
            <result property="bookCateNm" column="bookCateNm"/>
            <result property="bookName" column="bookName"/>
            <result property="author" column="author"/>
            <result property="bookPrice" column="bookPrice"/>
            <result property="publishDate" column="publishDate"/>
            <result property="bookImgPath" column="bookImgPath"/>
        </association>
    </resultMap>

    <select id="getWishList" parameterType="String" resultMap="wishListMap">
        with userWish as (
            select
                "wishId",
                "wishDate",
                "clientId",
                "bookId"
            from
                wishList
            where "clientId" = #{clientId})

        select
            w."wishId",
            w."wishDate",
            w."clientId",
            b."bookId" ,
            b."bookName",
            b."bookCateNm",
            b."author",
            b."bookPrice",
            b."publishDate",
            b."bookImgPath"
        from userWish w join book b on w."bookId"  = b."bookId"
        order by w."wishDate" desc
    </select>



    <!--    null 방지 처리는 Integer 타입 선언 또는 Count로 결과값 반환 -->
    <select id="existWishList" parameterType="String">
        SELECT COUNT(*) FROM WISHLIST
        WHERE "clientId" = #{clientId} AND "bookId" = #{bookId}
    </select>

    <insert id="insertWishList" parameterType="String">
        <selectKey keyProperty="wishId" resultType="String" order="BEFORE">
            SELECT WISH_QEC.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO WISHLIST
            ("wishId","clientId","bookId")
        values(#{wishId},#{clientId},#{bookId})
    </insert>


    <!--행을 삭제하지 않아서 유저의 찜목록 히스토리 추적가능-->
    <update id="wishListStatus" parameterType="String">
        update WISHLIST
        set "wishStatus" =
            case
               when"wishStatus"= 'Y'
                then 'N'
                else 'Y'
            end
        where "clientId"=#{clientId}
          and "bookId"=#{bookId}
    </update>

    <!-- 마이페이지 찜목록  조회-->



</mapper>